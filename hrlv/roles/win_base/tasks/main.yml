---
# win_base â€” Layer 0: Windows VM base configuration
# Ensures SSH, WinRM, firewall, auto-logon, and power settings are correct.
# Prerequisite: bootstrap-winrm.ps1 must have been run via Proxmox console first.

- name: Ensure OpenSSH Server is installed
  ansible.windows.win_optional_feature:
    name: OpenSSH.Server~~~~0.0.1.0
    state: present
  register: ssh_feature

- name: Ensure sshd service is running
  ansible.windows.win_service:
    name: sshd
    start_mode: auto
    state: started

- name: Ensure WinRM service is running
  ansible.windows.win_service:
    name: WinRM
    start_mode: auto
    state: started

- name: Set network profile to Private
  ansible.windows.win_shell: |
    Get-NetConnectionProfile | Where-Object { $_.NetworkCategory -ne 'Private' } | Set-NetConnectionProfile -NetworkCategory Private
  changed_when: false

- name: Ensure firewall rules for SSH
  community.windows.win_firewall_rule:
    name: OpenSSH-Server-In-TCP
    localport: 22
    action: allow
    direction: in
    protocol: tcp
    profiles: any
    state: present
    enabled: true

- name: Ensure firewall rules for WinRM
  community.windows.win_firewall_rule:
    name: WinRM-HTTP-In-TCP
    localport: 5985
    action: allow
    direction: in
    protocol: tcp
    profiles: any
    state: present
    enabled: true

- name: Ensure firewall allows ICMP
  community.windows.win_firewall_rule:
    name: Allow-ICMPv4
    action: allow
    direction: in
    protocol: icmpv4
    profiles: any
    state: present
    enabled: true

- name: Verify auto-logon is configured
  ansible.windows.win_shell: |
    $path = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
    $val = Get-ItemProperty -Path $path -Name AutoAdminLogon -ErrorAction SilentlyContinue
    if ($val.AutoAdminLogon -eq "1") { "enabled" } else { "disabled" }
  register: autologon_check
  changed_when: false

- name: Warn if auto-logon is not configured
  ansible.builtin.debug:
    msg: "WARNING: Auto-logon is not enabled on {{ inventory_hostname }}. Run bootstrap-winrm.ps1 on the node to configure it."
  when: "'disabled' in autologon_check.stdout"

- name: Disable lock screen
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
    name: NoLockScreen
    data: 1
    type: dword

- name: Disable sleep on AC power
  ansible.windows.win_shell: powercfg /change standby-timeout-ac 0
  changed_when: false
  when: win_base_disable_sleep

- name: Disable hibernation
  ansible.windows.win_shell: powercfg /hibernate off
  changed_when: false
  when: win_base_disable_hibernation

- name: Set high performance power plan
  ansible.windows.win_shell: |
    $highPerf = powercfg /list | Select-String "High performance"
    if ($highPerf -match "([a-f0-9-]{36})") {
      powercfg /setactive $matches[1]
      "activated"
    } else {
      "not_found"
    }
  register: power_plan
  changed_when: "'activated' in power_plan.stdout"
