---
# Install Plastic SCM (Unity Version Control) CLI on nodes
# Usage: ansible-playbook -i inventory.yml plastic-install.yml

- name: Install Plastic SCM CLI on nodes
  hosts: pulse_nodes
  become: true
  gather_facts: true

  vars:
    plastic_repo_key_url: "https://www.plasticscm.com/plasticrepo/plasticscm-cloud.gpg.key"
    plastic_repo_url: "https://www.plasticscm.com/plasticrepo/plasticscm-cloud-stable/ubuntu"

  tasks:
    - name: Check if cm is already installed
      ansible.builtin.command: which cm
      register: cm_installed
      changed_when: false
      failed_when: false

    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
        state: present
        update_cache: true
      when: cm_installed.rc != 0

    - name: Add Plastic SCM GPG key
      ansible.builtin.apt_key:
        url: "{{ plastic_repo_key_url }}"
        state: present
      when: cm_installed.rc != 0

    - name: Add Plastic SCM repository
      ansible.builtin.apt_repository:
        repo: "deb {{ plastic_repo_url }} ./"
        state: present
        filename: plasticscm
      when: cm_installed.rc != 0

    - name: Install Plastic SCM client
      ansible.builtin.apt:
        name: plasticscm-cloud
        state: present
        update_cache: true
      when: cm_installed.rc != 0

    - name: Verify installation
      ansible.builtin.command: cm version
      register: cm_version
      changed_when: false

    - name: Display version
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ cm_version.stdout }}"
