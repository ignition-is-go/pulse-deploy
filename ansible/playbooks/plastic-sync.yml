---
# Ansible playbook to sync Plastic SCM repos on Proxmox VM nodes
# Usage:
#   ansible-playbook -i inventory.yml plastic-sync.yml
#   ansible-playbook -i inventory.yml plastic-sync.yml -e "plastic_branch=/feature/xyz"

- name: Sync Plastic SCM workspaces on nodes
  hosts: pulse_nodes
  become: false
  gather_facts: true

  vars:
    # Override these in inventory or via -e
    plastic_workspace: "{{ lookup('env', 'PLASTIC_WORKSPACE') | default('/opt/pulse/workspace', true) }}"
    plastic_repo: "{{ lookup('env', 'PLASTIC_REPO') | default('P-0616-HRLV', true) }}"
    plastic_server: "{{ lookup('env', 'PLASTIC_SERVER') | default('cloud', true) }}"
    plastic_token: "{{ lookup('env', 'PLASTIC_TOKEN') | default('', true) }}"
    plastic_branch: "{{ lookup('env', 'PLASTIC_BRANCH') | default('/main', true) }}"

  tasks:
    - name: Check if Plastic SCM CLI is installed
      ansible.builtin.command: which cm
      register: cm_check
      changed_when: false
      failed_when: false

    - name: Fail if cm not installed
      ansible.builtin.fail:
        msg: "Plastic SCM CLI (cm) not found on {{ inventory_hostname }}"
      when: cm_check.rc != 0

    - name: Check if workspace exists
      ansible.builtin.stat:
        path: "{{ plastic_workspace }}/.plastic"
      register: workspace_stat

    - name: Configure token auth if provided
      ansible.builtin.shell: |
        cm profile list 2>/dev/null | grep -q "{{ plastic_server }}" && cm profile delete "{{ plastic_server }}" || true
        cm profile create "{{ plastic_server }}" --token="{{ plastic_token }}"
      when: plastic_token | length > 0
      no_log: true

    - name: Clone repository if workspace doesn't exist
      ansible.builtin.command:
        cmd: "cm clone {{ plastic_repo }}@{{ plastic_server }} {{ plastic_workspace }}"
        creates: "{{ plastic_workspace }}/.plastic"
      when:
        - not workspace_stat.stat.exists
        - plastic_repo | length > 0

    - name: Get current workspace status
      ansible.builtin.command:
        cmd: cm status --short
        chdir: "{{ plastic_workspace }}"
      register: workspace_status
      changed_when: false
      failed_when: false

    - name: Warn about local changes
      ansible.builtin.debug:
        msg: "WARNING: Workspace has local changes: {{ workspace_status.stdout }}"
      when: workspace_status.stdout | length > 0

    - name: Switch to target branch
      ansible.builtin.command:
        cmd: cm switch {{ plastic_branch }}
        chdir: "{{ plastic_workspace }}"
      register: switch_result
      changed_when: "'Switched' in switch_result.stdout"
      failed_when: false
      when: plastic_branch != '/main'

    - name: Update workspace to latest
      ansible.builtin.command:
        cmd: cm update --last
        chdir: "{{ plastic_workspace }}"
      register: update_result
      changed_when: "'Updated' in update_result.stdout or 'updated' in update_result.stdout"

    - name: Get current changeset
      ansible.builtin.command:
        cmd: cm status --header
        chdir: "{{ plastic_workspace }}"
      register: changeset_info
      changed_when: false

    - name: Display sync result
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ changeset_info.stdout_lines[0] | default('Sync complete') }}"
