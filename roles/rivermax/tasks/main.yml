---
# rivermax â€” Layer 1: WinOF-2 + Rivermax SDK + license
# Only applied when host var `rivermax: true` is set.
# Extracted from setup-rivermax.yml playbook.

# --- Temp directory ---

- name: Ensure temp directory exists
  ansible.windows.win_file:
    path: "C:\\temp"
    state: directory

# --- WinOF-2 Driver ---

- name: Get WinOF-2 version
  ansible.windows.win_shell: |
    $reg = Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' |
      Where-Object { $_.DisplayName -like '*WinOF*' }
    if ($reg) { $reg.DisplayVersion } else { "not_installed" }
  register: winof2_check
  changed_when: false

- name: Report WinOF-2 version
  ansible.builtin.debug:
    msg: "WinOF-2: {{ winof2_check.stdout | trim }} (expected {{ rivermax_winof2_version }})"

- name: Copy WinOF-2 installer to node
  ansible.windows.win_copy:
    src: "{{ rivermax_winof2_installer }}"
    dest: "C:\\temp\\winof2_installer.exe"
    remote_src: "{{ rivermax_installers_remote | default(true) }}"
  when: winof2_check.stdout | trim != rivermax_winof2_version

- name: Install WinOF-2 with Rivermax support
  ansible.windows.win_shell: |
    Start-Process -FilePath "C:\temp\winof2_installer.exe" `
      -ArgumentList '/v"MT_RIVERMAX=1" /S /v/qn /v"/log C:\temp\winof2_install.log"' `
      -Wait -PassThru
  register: winof2_install
  when: winof2_check.stdout | trim != rivermax_winof2_version

- name: Reboot after WinOF-2 install
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when:
    - winof2_check.stdout | trim != rivermax_winof2_version
    - winof2_install is changed

# --- Rivermax SDK ---

- name: Get Rivermax SDK version
  ansible.windows.win_shell: |
    $reg = Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' |
      Where-Object { $_.DisplayName -like '*Rivermax*' }
    if ($reg) { $reg.DisplayVersion } else { "not_installed" }
  register: rivermax_sdk_check
  changed_when: false

- name: Report Rivermax SDK version
  ansible.builtin.debug:
    msg: "Rivermax SDK: {{ rivermax_sdk_check.stdout | trim }} (expected {{ rivermax_sdk_version_dotted }})"

- name: Copy Rivermax SDK archive to node
  ansible.windows.win_copy:
    src: "{{ rivermax_sdk_installer }}"
    dest: "C:\\temp\\rivermax_sdk.zip"
    remote_src: "{{ rivermax_installers_remote | default(true) }}"
  when: rivermax_sdk_check.stdout | trim != rivermax_sdk_version_dotted

- name: Extract Rivermax SDK archive
  community.windows.win_unzip:
    src: "C:\\temp\\rivermax_sdk.zip"
    dest: "C:\\temp\\rivermax_sdk"
  when: rivermax_sdk_check.stdout | trim != rivermax_sdk_version_dotted

- name: Install Rivermax SDK via MSI
  ansible.windows.win_package:
    path: "C:\\temp\\rivermax_sdk\\Rivermax_Windows_{{ rivermax_sdk_version_dotted }}\\Rivermax-{{ rivermax_sdk_version_dotted }}-win64.msi"
    state: present
  register: rivermax_sdk_install
  when: rivermax_sdk_check.stdout | trim != rivermax_sdk_version_dotted

# --- License ---

- name: Ensure license directory exists
  ansible.windows.win_file:
    path: "{{ rivermax_install_dir }}\\lib"
    state: directory

- name: Copy Rivermax license
  ansible.windows.win_copy:
    src: "{{ rivermax_license_src }}"
    dest: "{{ rivermax_install_dir }}\\lib\\rivermax.lic"
    remote_src: "{{ rivermax_installers_remote | default(true) }}"

- name: Set RIVERMAX_LICENSE_PATH system environment variable
  ansible.windows.win_environment:
    name: RIVERMAX_LICENSE_PATH
    value: "{{ rivermax_install_dir }}\\lib\\rivermax.lic"
    level: machine
    state: present

- name: Set RIVERMAX_PATH_{{ rivermax_sdk_version }} system environment variable
  ansible.windows.win_environment:
    name: "RIVERMAX_PATH_{{ rivermax_sdk_version }}"
    value: "{{ rivermax_install_dir }}"
    level: machine
    state: present

- name: Set RIVERMAX_ENABLE_CUDA system environment variable
  ansible.windows.win_environment:
    name: RIVERMAX_ENABLE_CUDA
    value: "1"
    level: machine
    state: present

# --- Validation ---

- name: Verify WinOF-2 version
  ansible.windows.win_shell: |
    $reg = Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' |
      Where-Object { $_.DisplayName -like '*WinOF*' }
    if ($reg) { $reg.DisplayVersion } else { "not_installed" }
  register: final_winof2_check
  changed_when: false

- name: Fail if WinOF-2 version mismatch
  ansible.builtin.fail:
    msg: "WinOF-2 version {{ final_winof2_check.stdout | trim }} does not match expected {{ rivermax_winof2_version }}"
  when: final_winof2_check.stdout | trim != rivermax_winof2_version

- name: Verify Rivermax SDK version
  ansible.windows.win_shell: |
    $reg = Get-ItemProperty 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*' |
      Where-Object { $_.DisplayName -like '*Rivermax*' }
    if ($reg) { $reg.DisplayVersion } else { "not_installed" }
  register: final_sdk_check
  changed_when: false

- name: Fail if Rivermax SDK version mismatch
  ansible.builtin.fail:
    msg: "Rivermax SDK version {{ final_sdk_check.stdout | trim }} does not match expected {{ rivermax_sdk_version_dotted }}"
  when: final_sdk_check.stdout | trim != rivermax_sdk_version_dotted

- name: Verify Rivermax DLL exists
  ansible.windows.win_stat:
    path: "{{ rivermax_install_dir }}\\lib\\rivermax.dll"
  register: final_dll_check

- name: Fail if Rivermax DLL missing
  ansible.builtin.fail:
    msg: "Rivermax DLL not found at {{ rivermax_install_dir }}\\lib\\rivermax.dll"
  when: not final_dll_check.stat.exists

- name: Verify license file exists
  ansible.windows.win_stat:
    path: "{{ rivermax_install_dir }}\\lib\\rivermax.lic"
  register: final_lic_check

- name: Fail if license file missing
  ansible.builtin.fail:
    msg: "Rivermax license not found at {{ rivermax_install_dir }}\\lib\\rivermax.lic"
  when: not final_lic_check.stat.exists

- name: Check Mellanox adapter is visible
  ansible.windows.win_shell: |
    Get-NetAdapter | Where-Object { $_.InterfaceDescription -like '*Mellanox*' -or $_.InterfaceDescription -like '*ConnectX*' } | Format-Table Name, InterfaceDescription, Status -AutoSize
  register: adapter_check
  changed_when: false

- name: Display Rivermax status
  ansible.builtin.debug:
    msg: |
      WinOF-2: {{ final_winof2_check.stdout | trim }} (expected {{ rivermax_winof2_version }})
      Rivermax SDK: {{ final_sdk_check.stdout | trim }} (expected {{ rivermax_sdk_version_dotted }})
      Rivermax DLL: OK
      License file: OK
      Adapters:
      {{ adapter_check.stdout }}

- name: Cleanup temp installers
  ansible.windows.win_file:
    path: "C:\\temp\\{{ item }}"
    state: absent
  loop:
    - winof2_installer.exe
    - rivermax_sdk.zip
    - rivermax_sdk
