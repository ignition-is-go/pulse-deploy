---
# win_base â€” Layer 0: Windows VM base configuration
# Ensures WinRM, firewall, auto-logon, and power settings are correct.
# Prerequisite: scripts/bootstrap-ansible.ps1 must have been run via Proxmox console first.

- name: Ensure WinRM service is running
  ansible.windows.win_service:
    name: WinRM
    start_mode: auto
    state: started

- name: Set DNS servers
  ansible.windows.win_dns_client:
    adapter_names: '*'
    dns_servers: "{{ win_base_dns_servers }}"

- name: Set network profile to Private
  ansible.windows.win_shell: |
    Get-NetConnectionProfile | Where-Object { $_.NetworkCategory -ne 'Private' } | Set-NetConnectionProfile -NetworkCategory Private
  changed_when: false

- name: Ensure firewall rules for WinRM
  community.windows.win_firewall_rule:
    name: WinRM-HTTP-In-TCP
    localport: 5985
    action: allow
    direction: in
    protocol: tcp
    profiles:
      - domain
      - private
      - public
    state: present
    enabled: true

- name: Ensure firewall allows ICMP
  community.windows.win_firewall_rule:
    name: Allow-ICMPv4
    action: allow
    direction: in
    protocol: icmpv4
    profiles:
      - domain
      - private
      - public
    state: present
    enabled: true

- name: Configure auto-logon
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: string
  loop:
    - { name: AutoAdminLogon, data: "1" }
    - { name: DefaultUserName, data: "{{ ansible_user }}" }
    - { name: DefaultPassword, data: "{{ ansible_password }}" }
    - { name: DefaultDomainName, data: "" }
  no_log: true

- name: Disable lock screen
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
    name: NoLockScreen
    data: 1
    type: dword

- name: Disable sleep on AC power
  ansible.windows.win_shell: powercfg /change standby-timeout-ac 0
  changed_when: false
  when: win_base_disable_sleep

- name: Disable hibernation
  ansible.windows.win_shell: powercfg /hibernate off
  changed_when: false
  when: win_base_disable_hibernation

- name: Set high performance power plan
  ansible.windows.win_shell: |
    $highPerf = powercfg /list | Select-String "High performance"
    if ($highPerf -match "([a-f0-9-]{36})") {
      powercfg /setactive $matches[1]
      "activated"
    } else {
      "not_found"
    }
  register: power_plan
  changed_when: "'activated' in power_plan.stdout"
