---
# plastic_scm/tasks/linux.yml â€” Linux (Debian/Ubuntu) Plastic SCM install + workspace sync

# --- Installation ---

- name: Check if cm is already installed
  ansible.builtin.command: which cm
  register: cm_installed
  changed_when: false
  failed_when: false

- name: Install Plastic SCM CLI
  when: cm_installed.rc != 0
  become: true
  block:
    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
        state: present
        update_cache: true

    - name: Add Plastic SCM GPG key
      ansible.builtin.apt_key:
        url: "{{ plastic_repo_key_url }}"
        state: present

    - name: Add Plastic SCM repository
      ansible.builtin.apt_repository:
        repo: "deb {{ plastic_repo_url }} ./"
        state: present
        filename: plasticscm

    - name: Install Plastic SCM client
      ansible.builtin.apt:
        name: plasticscm-cloud
        state: present
        update_cache: true

- name: Verify Plastic CLI
  ansible.builtin.command: cm version
  register: cm_version
  changed_when: false

- name: Display Plastic version
  ansible.builtin.debug:
    msg: "{{ inventory_hostname }}: {{ cm_version.stdout }}"

# --- Authentication ---

- name: Configure token auth (if API key provided)
  when: plastic_api_key | length > 0
  ansible.builtin.shell: |
    cm profile list 2>/dev/null | grep -q "{{ plastic_server }}" && cm profile delete "{{ plastic_server }}" || true
    cm profile create "{{ plastic_server }}" --token="{{ plastic_api_key }}"
  no_log: true

# --- Workspace sync ---

- name: Sync workspace
  when: plastic_workspace | length > 0
  block:
    - name: Check if workspace exists
      ansible.builtin.stat:
        path: "{{ plastic_workspace }}/.plastic"
      register: workspace_stat

    - name: Clone repository if workspace doesn't exist
      ansible.builtin.command:
        cmd: "cm clone {{ plastic_repo }}@{{ plastic_server }} {{ plastic_workspace }}"
        creates: "{{ plastic_workspace }}/.plastic"
      when:
        - not workspace_stat.stat.exists
        - plastic_repo | length > 0

    - name: Get current workspace status
      ansible.builtin.command:
        cmd: cm status --short
        chdir: "{{ plastic_workspace }}"
      register: workspace_status
      changed_when: false
      failed_when: false

    - name: Warn about local changes
      ansible.builtin.debug:
        msg: "WARNING: Workspace has local changes: {{ workspace_status.stdout }}"
      when: workspace_status.stdout | length > 0

    - name: Switch to target branch
      ansible.builtin.command:
        cmd: "cm switch {{ plastic_branch }}"
        chdir: "{{ plastic_workspace }}"
      register: switch_result
      changed_when: "'Switched' in switch_result.stdout"
      failed_when: false
      when: plastic_branch != '/main'

    - name: Update workspace to latest
      ansible.builtin.command:
        cmd: cm update --last
        chdir: "{{ plastic_workspace }}"
      register: update_result
      changed_when: "'Updated' in update_result.stdout or 'updated' in update_result.stdout"

    - name: Get current changeset
      ansible.builtin.command:
        cmd: cm status --header
        chdir: "{{ plastic_workspace }}"
      register: changeset_info
      changed_when: false

    - name: Display sync result
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ changeset_info.stdout_lines[0] | default('Sync complete') }}"
