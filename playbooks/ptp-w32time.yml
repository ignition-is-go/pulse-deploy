---
# ptp-w32time.yml â€” Configure W32Time PTP client on render nodes
#
# Follows Microsoft's official PTP client configuration:
#   https://github.com/microsoft/W32Time/blob/master/Precision%20Time%20Protocol/Windows%20Configuration%20Helpers/PTPClientConfig.txt
#   https://learn.microsoft.com/en-us/windows-server/networking/windows-time-service/configuring-systems-for-high-accuracy
#
# Usage:
#   ansible-playbook playbooks/ptp-w32time.yml                                    # all rivermax nodes
#   ansible-playbook playbooks/ptp-w32time.yml --limit content_nodes              # content only
#   ansible-playbook playbooks/ptp-w32time.yml --limit windows-unreal-render-01   # single node
#   ansible-playbook playbooks/ptp-w32time.yml --check                            # dry run

- name: Configure W32Time PTP client
  hosts: ue_nodes:touch_nodes
  gather_facts: false

  vars:
    ptp_masters: "10.0.0.100"
    ptp_domain: 0

  tasks:
    # --- PTP Client provider (Microsoft PTPClientConfig.txt) ---

    - name: Set PTP grandmaster(s)
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: PtpMasters
        data: "{{ ptp_masters }}"
        type: string
      when: rivermax | default(false)

    - name: Enable PTP client provider
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: Enabled
        data: 1
        type: dword
      when: rivermax | default(false)

    - name: Set PTP client as input provider
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: InputProvider
        data: 1
        type: dword
      when: rivermax | default(false)

    - name: Set PTP client DLL
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: DllName
        data: "C:\\Windows\\System32\\ptpprov.dll"
        type: string
      when: rivermax | default(false)

    - name: Set PTP DelayPollInterval
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: DelayPollInterval
        data: 0x3e80
        type: dword
      when: rivermax | default(false)

    - name: Set PTP AnnounceInterval
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: AnnounceInterval
        data: 0x0fa0
        type: dword
      when: rivermax | default(false)

    # --- Multicast and delay settings ---

    - name: Enable PTP multicast RX
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: EnableMulticastRx
        data: 1
        type: dword
      when: rivermax | default(false)

    - name: Enable PTP multicast TX
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: EnableMulticastTx
        data: 1
        type: dword
      when: rivermax | default(false)

    - name: Enable E2E delay correction
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: UseE2ECorrection
        data: 1
        type: dword
      when: rivermax | default(false)

    - name: Set PTP domain number
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\PtpClient
        name: DomainNumber
        data: "{{ ptp_domain }}"
        type: dword
      when: rivermax | default(false)

    # --- Disable competing time providers (per Microsoft guide) ---

    - name: Disable NTP client provider
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
        name: Enabled
        data: 0
        type: dword
      when: rivermax | default(false)

    - name: Disable Hyper-V VMIC time provider
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\VMICTimeProvider
        name: Enabled
        data: 0
        type: dword
      when: rivermax | default(false)

    # --- High accuracy settings (Microsoft high-accuracy guide) ---

    - name: Set MinPollInterval to 64s (log2 = 6)
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config
        name: MinPollInterval
        data: 6
        type: dword
      when: rivermax | default(false)

    - name: Set MaxPollInterval to 64s (log2 = 6)
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config
        name: MaxPollInterval
        data: 6
        type: dword
      when: rivermax | default(false)

    - name: Set UpdateInterval to 100
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config
        name: UpdateInterval
        data: 100
        type: dword
      when: rivermax | default(false)

    - name: Set FrequencyCorrectRate to 2
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config
        name: FrequencyCorrectRate
        data: 2
        type: dword
      when: rivermax | default(false)

    - name: Disable Secure Time Seeding
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\W32Time\Config
        name: UtilizeSslTimeData
        data: 0
        type: dword
      when: rivermax | default(false)

    # --- Firewall rules for PTP ---

    - name: Allow PTP Event port (UDP 319)
      community.windows.win_firewall_rule:
        name: PTP Event (UDP 319)
        direction: in
        protocol: udp
        localport: 319
        action: allow
        enabled: true
      when: rivermax | default(false)

    - name: Allow PTP General port (UDP 320)
      community.windows.win_firewall_rule:
        name: PTP General (UDP 320)
        direction: in
        protocol: udp
        localport: 320
        action: allow
        enabled: true
      when: rivermax | default(false)

    - name: Block PTP on management NIC (outbound)
      community.windows.win_firewall_rule:
        name: Block PTP on management NIC
        direction: out
        protocol: udp
        localport: "319,320"
        action: block
        enabled: true
        localip: "{{ ansible_host }}"
      when: rivermax | default(false)

    # --- Set W32Time to auto-start and restart ---

    - name: Set W32Time service to automatic startup
      ansible.windows.win_service:
        name: w32time
        start_mode: auto
      when: rivermax | default(false)

    - name: Apply config and restart W32Time
      ansible.windows.win_shell: |
        w32tm /config /update
        Restart-Service w32time
        Start-Sleep -Seconds 3
        w32tm /resync /force
      when: rivermax | default(false)

    # --- Verify ---

    - name: Query W32Time PTP status
      ansible.windows.win_shell: |
        w32tm /query /status /verbose
      register: w32time_status
      changed_when: false
      when: rivermax | default(false)

    - name: Display W32Time status
      ansible.builtin.debug:
        msg: "{{ w32time_status.stdout_lines }}"
      when: rivermax | default(false)
