---
# Start Rivermax media_sender (persistent, runs until stopped)
# Sends a test 2110-20 stream from the node's media_ip.
#
# Usage:
#   ansible-playbook playbooks/rivermax-media-sender-start.yml --limit windows-unreal-render-01
#   ansible-playbook playbooks/rivermax-media-sender-start.yml --limit content_nodes -e "rmax_dst_ip=10.0.0.5"
#   ansible-playbook playbooks/rivermax-media-sender-start.yml --limit content_nodes -e "rmax_dst_ip=225.0.0.1"

- name: Prime OVS FDB for Rivermax hardware offload
  ansible.builtin.import_playbook: rivermax-arp-prime.yml

- name: Start Rivermax media_sender
  hosts: windows
  gather_facts: false

  vars:
    rmax_sender: 'C:\Program Files\Mellanox\Rivermax\apps\media_sender\media_sender.exe'
    rmax_dst_ip: "10.0.0.5"
    rmax_dst_port: 50000
    rmax_fps: "60"

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\temp"
        state: directory

    - name: Write SDP file
      ansible.windows.win_copy:
        content: |
          v=0
          o=- 0 0 IN IP4 {{ media_ip }}
          s=Rivermax TX {{ inventory_hostname }}
          c=IN IP4 {{ rmax_dst_ip }}/1
          t=0 0
          m=video {{ rmax_dst_port }} RTP/AVP 96
          a=rtpmap:96 raw/90000
          a=fmtp:96 sampling=YCbCr-4:2:2; width=4096; height=1080; depth=10; exactframerate=60; colorimetry=BT709; PM=2110GPM; SSN=ST2110-20:2017; TP=2110TPN
          a=source-filter: incl IN IP4 {{ rmax_dst_ip }} {{ media_ip }}
        dest: C:\temp\rmax-tx.sdp

    - name: Write TX launch script
      ansible.windows.win_copy:
        content: |
          & "{{ rmax_sender }}" -s C:\temp\rmax-tx.sdp --src-ip={{ media_ip }} --dst-ip={{ rmax_dst_ip }} --dst-port={{ rmax_dst_port }} --fps={{ rmax_fps }} -v system 2>&1 | Tee-Object -FilePath C:\temp\rmax-tx.log
        dest: C:\temp\rmax-tx.ps1

    - name: Create TX scheduled task
      community.windows.win_scheduled_task:
        name: RivermaxMediaSender
        description: Rivermax media_sender
        actions:
          - path: powershell.exe
            arguments: -ExecutionPolicy Bypass -File C:\temp\rmax-tx.ps1
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

    - name: Start TX
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "RivermaxMediaSender"

    - name: Verify media_sender is running
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 3
        $proc = Get-Process -Name media_sender -ErrorAction SilentlyContinue
        if ($proc) {
          Write-Host "RUNNING (PID $($proc.Id))"
        } else {
          Write-Host "FAILED TO START"
        }
      register: tx_status

    - name: Show TX status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} ({{ media_ip }}): {{ tx_status.stdout | trim }}"
