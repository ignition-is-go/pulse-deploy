---
# Run rmax_stats against the UE process to check Rivermax stream status
# Must run in interactive session (Session 1) for shared memory access.
#
# Usage:
#   ansible-playbook playbooks/rmax-stats.yml --limit content_nodes
#   ansible-playbook playbooks/rmax-stats.yml --limit windows-unreal-render-01

- name: Rivermax stats check
  hosts: windows
  gather_facts: false

  vars:
    rmax_stats: 'C:\Program Files\Mellanox\Rivermax\bin\rmax_stats.exe'
    rmax_stats_duration: 5

  tasks:
    - name: Check for running UE process
      ansible.windows.win_shell: |
        $p = Get-Process -Name UnrealEditor -ErrorAction SilentlyContinue
        if ($p) { $p.Id } else { "NOT_RUNNING" }
      register: ue_pid
      changed_when: false

    - name: Fail if UE not running
      ansible.builtin.fail:
        msg: "UnrealEditor is not running on {{ inventory_hostname }}"
      when: "'NOT_RUNNING' in ue_pid.stdout"

    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\temp"
        state: directory

    - name: Write rmax_stats script
      ansible.windows.win_copy:
        content: |
          @echo off
          "{{ rmax_stats }}" --process-id {{ ue_pid.stdout | trim }} > C:\temp\rmax-stats.log 2>&1
        dest: C:\temp\rmax-stats.bat

    - name: Remove old stats results
      ansible.windows.win_file:
        path: "C:\\temp\\rmax-stats.log"
        state: absent

    - name: Create rmax_stats scheduled task
      community.windows.win_scheduled_task:
        name: RmaxStats
        description: Rivermax stats check
        actions:
          - path: C:\temp\rmax-stats.bat
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

    - name: Run rmax_stats
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "RmaxStats"
        Write-Host "STARTED"

    - name: Wait and collect output
      ansible.windows.win_shell: |
        Start-Sleep -Seconds {{ rmax_stats_duration }}
        Stop-ScheduledTask -TaskName "RmaxStats" -ErrorAction SilentlyContinue
        if (Test-Path C:\temp\rmax-stats.log) {
          Get-Content C:\temp\rmax-stats.log
        } else {
          Write-Host "NO OUTPUT"
        }
      register: stats_output

    - name: Show rmax_stats results
      ansible.builtin.debug:
        msg: "{{ stats_output.stdout }}"

    - name: Clean up scheduled task
      community.windows.win_scheduled_task:
        name: RmaxStats
        state: absent
