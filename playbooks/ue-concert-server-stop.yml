---
# Stop the Concert (Multi-User Editing) server
#
# Usage:
#   ansible-playbook playbooks/ue-concert-server-stop.yml

- name: Stop Concert server
  hosts: ue_editing
  gather_facts: false

  tasks:
    - name: Stop UnrealMultiUserServer process
      ansible.windows.win_shell: |
        $proc = Get-Process -Name UnrealMultiUserServer -ErrorAction SilentlyContinue
        if ($proc) {
          $proc | Stop-Process -Force
          Start-Sleep -Seconds 2
          Write-Host "STOPPED"
        } else {
          Write-Host "NONE_RUNNING"
        }
      register: stop_result

    - name: Remove Concert server scheduled task
      community.windows.win_scheduled_task:
        name: ConcertServer
        state: absent

    - name: Show status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ stop_result.stdout | trim }}"
