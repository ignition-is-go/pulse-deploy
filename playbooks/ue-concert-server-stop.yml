---
# Stop the Concert (Multi-User Editing) server
#
# Usage:
#   ansible-playbook playbooks/ue-concert-server-stop.yml

- name: Stop Concert server
  hosts: ue_editing
  gather_facts: false

  tasks:
    - name: Graceful shutdown of Concert server (WM_CLOSE then force-kill)
      ansible.windows.win_shell: |
        $procs = Get-Process -Name UnrealMultiUserServer -ErrorAction SilentlyContinue
        if (-not $procs) {
          Write-Host "NONE_RUNNING"
          exit 0
        }
        $count = $procs.Count
        foreach ($p in $procs) {
          $p.CloseMainWindow() | Out-Null
        }
        $timeout = 10
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          Start-Sleep -Seconds 2
          $elapsed += 2
          $remaining = Get-Process -Name UnrealMultiUserServer -ErrorAction SilentlyContinue
          if (-not $remaining) {
            Write-Host "GRACEFUL_STOP $count process(es)"
            exit 0
          }
        }
        $remaining = Get-Process -Name UnrealMultiUserServer -ErrorAction SilentlyContinue
        if ($remaining) {
          $remaining | Stop-Process -Force
          Start-Sleep -Seconds 2
          Write-Host "FORCE_STOP $count process(es) (graceful timed out after ${timeout}s)"
        }
      register: stop_result

    - name: Remove Concert server scheduled task
      community.windows.win_scheduled_task:
        name: ConcertServer
        state: absent

    - name: Show status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }}: {{ stop_result.stdout | trim }}"
