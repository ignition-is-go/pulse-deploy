---
# Start Rivermax media_receiver (persistent, runs until stopped)
# Listens for a 2110-20 stream on the node's media_ip.
#
# Usage:
#   ansible-playbook playbooks/rivermax-rx-start.yml --limit windows-unreal-render-05
#   ansible-playbook playbooks/rivermax-rx-start.yml --limit windows-unreal-render-05 -e "rmax_src_ip=10.0.0.1"

- name: Start Rivermax media_receiver
  hosts: windows
  gather_facts: false

  vars:
    rmax_receiver: 'C:\Program Files\Mellanox\Rivermax\apps\media_receiver\media_receiver.exe'
    rmax_src_ip: "10.0.0.1"
    rmax_dst_ip: "{{ media_ip }}"
    rmax_dst_port: 50000

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\temp"
        state: directory

    - name: Write SDP file
      ansible.windows.win_copy:
        content: |
          v=0
          o=- 0 0 IN IP4 {{ rmax_src_ip }}
          s=Rivermax RX {{ inventory_hostname }}
          c=IN IP4 {{ rmax_dst_ip }}/1
          t=0 0
          m=video {{ rmax_dst_port }} RTP/AVP 96
          a=rtpmap:96 raw/90000
          a=fmtp:96 sampling=YCbCr-4:2:2; width=1920; height=1080; depth=10; exactframerate=29.97; colorimetry=BT709; PM=2110GPM; SSN=ST2110-20:2017; TP=2110TPN
          a=source-filter: incl IN IP4 {{ rmax_dst_ip }} {{ rmax_src_ip }}
        dest: C:\temp\rmax-rx.sdp

    - name: Write RX batch file
      ansible.windows.win_copy:
        content: |
          @echo off
          "{{ rmax_receiver }}" --sdp-file C:\temp\rmax-rx.sdp -i {{ media_ip }}
        dest: C:\temp\rmax-rx.bat

    - name: Create RX scheduled task
      community.windows.win_scheduled_task:
        name: RivermaxMediaReceiver
        description: Rivermax media_receiver
        actions:
          - path: C:\temp\rmax-rx.bat
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

    - name: Start RX
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "RivermaxMediaReceiver"

    - name: Verify media_receiver is running
      ansible.windows.win_shell: |
        Start-Sleep -Seconds 3
        $proc = Get-Process -Name media_receiver -ErrorAction SilentlyContinue
        if ($proc) {
          Write-Host "RUNNING (PID $($proc.Id))"
        } else {
          if (Test-Path C:\temp\rmax-rx.log) {
            Get-Content C:\temp\rmax-rx.log
          }
          Write-Host "FAILED TO START"
        }
      register: rx_status

    - name: Show RX status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} ({{ media_ip }}): {{ rx_status.stdout | trim }}"
