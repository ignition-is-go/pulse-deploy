---
# site.yml — Full convergence playbook
#
# Applies all layers to every node type. Idempotent and safe to re-run.
#
# Usage:
#   ansible-playbook playbooks/site.yml                              # everything
#   ansible-playbook playbooks/site.yml --limit windows              # all Windows
#   ansible-playbook playbooks/site.yml --limit ue                   # UE nodes only
#   ansible-playbook playbooks/site.yml --limit windows-unreal-03    # single node
#   ansible-playbook playbooks/site.yml --limit rship                # rship nodes only
#   ansible-playbook playbooks/site.yml --check                      # dry run

# === Windows VMs ===

- name: Base config — all Windows
  hosts: windows
  gather_facts: true
  roles:
    - win_base

- name: GPU validation — Windows nodes with GPUs
  hosts: ue_content:ue_previs:touch:arnold_fusion:workstation
  gather_facts: false
  roles:
    - nvidia_gpu_win

- name: Rivermax — all Windows nodes with rivermax enabled
  hosts: windows
  gather_facts: false
  roles:
    - role: rivermax
      when: rivermax | default(false)

- name: All UE nodes — shared layers
  hosts: ue
  gather_facts: false
  roles:
    - plastic_scm

- name: Content nodes — nDisplay cluster
  hosts: ue_content
  gather_facts: false
  roles:
    - unreal_engine
    - render_worker

- name: Previs nodes
  hosts: ue_previs
  gather_facts: false
  roles:
    - unreal_engine
    - render_worker

- name: Staging nodes
  hosts: ue_staging
  gather_facts: false
  roles:
    - unreal_engine

- name: Touch nodes
  hosts: touch
  gather_facts: false
  roles: []

- name: Arnold/Fusion nodes
  hosts: arnold_fusion
  gather_facts: false
  roles:
    - arnold

# === Linux ===

- name: Base config — all Linux
  hosts: linux
  gather_facts: true
  roles:
    - linux_base

- name: Optik
  hosts: optik
  gather_facts: false
  roles:
    - nvidia_gpu_linux
    - optik

- name: rship workers
  hosts: rship
  gather_facts: false
  roles:
    - rship
