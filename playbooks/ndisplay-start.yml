---
# Launch nDisplay cluster via command line (no Switchboard)
# Starts UnrealEditor on each content node in nDisplay mode.
#
# Reference command (from Epic Forums):
#   https://forums.unrealengine.com/t/how-to-run-ndisplay-by-script-or-command-line/479685
#
#   UnrealEditor.exe "Project.uproject" -game None -messaging -dc_cluster -nosplash
#     -dc_cfg="path/to/config.ndisplay" -dc_node=Node_0 -dc_dev_mono
#     -ini:Engine:[/Script/Engine.Engine]:GameEngine=/Script/DisplayCluster.DisplayClusterGameEngine,[/Script/Engine.Engine]:GameViewportClientClassName=/Script/DisplayCluster.DisplayClusterViewportClient
#     -ini:Game:[/Script/EngineSettings.GeneralProjectSettings]:bUseBorderlessWindow=True
#     -ini:Input:[/Script/Engine.InputSettings]:DefaultPlayerInputClass=/Script/DisplayCluster.DisplayClusterPlayerInput
#     -unattended -NoScreenMessages -fixedseed -NoVerifyGC -noxrstereo
#     -RemoteControlIsHeadless -StageFriendlyName="Node_0" Log=Node_0.log
#
# Prerequisites:
#   - Populate ndisplay_map and ndisplay_config in
#     inventories/hrlv/group_vars/content_nodes.yml
#   - Plastic SCM synced (playbooks/plastic-sync.yml)
#   - Firewall rules applied (playbooks/ndisplay-network.yml)
#
# Usage:
#   ansible-playbook playbooks/ndisplay-start.yml
#   ansible-playbook playbooks/ndisplay-start.yml -e "ndisplay_map=/Game/Path/To/Map"

- name: Launch nDisplay cluster
  hosts: content_nodes
  gather_facts: false
  serial: 1

  tasks:
    - name: Validate nDisplay config is set
      ansible.builtin.assert:
        that:
          - ndisplay_config | length > 0
          - ndisplay_node is defined
        fail_msg: "ndisplay_config and ndisplay_node must be set. Populate content_nodes.yml and hosts.yml."

    - name: Stop any running UE instances
      ansible.windows.win_shell: |
        $procs = Get-Process -Name UnrealEditor -ErrorAction SilentlyContinue
        if ($procs) {
          $procs | Stop-Process -Force
          Start-Sleep -Seconds 3
          Write-Host "STOPPED $($procs.Count) process(es)"
        } else {
          Write-Host "NONE_RUNNING"
        }
      register: stop_result

    - name: Build nDisplay launch arguments
      ansible.builtin.set_fact:
        ndisplay_args: >-
          "{{ unreal_project }}"
          -game
          {{ ndisplay_map | default('None') }}
          -messaging
          -dc_cluster
          -dc_cfg="{{ ndisplay_config }}"
          -dc_node={{ ndisplay_node }}
          -dc_dev_mono
          -ini:Engine:[/Script/Engine.Engine]:GameEngine=/Script/DisplayCluster.DisplayClusterGameEngine,[/Script/Engine.Engine]:GameViewportClientClassName=/Script/DisplayCluster.DisplayClusterViewportClient
          -ini:Game:[/Script/EngineSettings.GeneralProjectSettings]:bUseBorderlessWindow=True
          -ini:Input:[/Script/Engine.InputSettings]:DefaultPlayerInputClass=/Script/DisplayCluster.DisplayClusterPlayerInput
          -unattended
          -NoScreenMessages
          -nosplash
          -fixedseed
          -NoVerifyGC
          -noxrstereo
          -RemoteControlIsHeadless
          -StageFriendlyName="{{ ndisplay_node }}"
          Log={{ ndisplay_node }}.log

    - name: Write nDisplay launch script
      ansible.windows.win_copy:
        content: |
          @echo off
          "{{ unreal_exe }}" {{ ndisplay_args }}
        dest: C:\ndisplay-launch.bat

    - name: Create nDisplay scheduled task
      community.windows.win_scheduled_task:
        name: nDisplayLaunch
        description: Launch UE in nDisplay mode
        actions:
          - path: C:\ndisplay-launch.bat
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

    - name: Run nDisplay launch task
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "nDisplayLaunch"
        Write-Host "LAUNCHED"

    - name: Wait for UE process to appear
      ansible.windows.win_shell: |
        $timeout = 30
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          $proc = Get-Process -Name UnrealEditor -ErrorAction SilentlyContinue
          if ($proc) {
            Write-Host "RUNNING (PID: $($proc.Id))"
            exit 0
          }
          Start-Sleep -Seconds 2
          $elapsed += 2
        }
        throw "UnrealEditor did not start within ${timeout}s"
      register: launch_result

    - name: Show launch status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} ({{ ndisplay_node }}): {{ launch_result.stdout | trim }}"
