---
# Launch nDisplay cluster via command line (no Switchboard)
# Starts UnrealEditor on each content node in nDisplay mode.
#
# Reference command (from Epic Forums):
#   https://forums.unrealengine.com/t/how-to-run-ndisplay-by-script-or-command-line/479685
#
#   UnrealEditor.exe "Project.uproject" -game None -messaging -dc_cluster -nosplash
#     -dc_cfg="path/to/config.ndisplay" -dc_node=Node_0 -dc_dev_mono
#     -ini:Engine:[/Script/Engine.Engine]:GameEngine=/Script/DisplayCluster.DisplayClusterGameEngine,[/Script/Engine.Engine]:GameViewportClientClassName=/Script/DisplayCluster.DisplayClusterViewportClient
#     -ini:Game:[/Script/EngineSettings.GeneralProjectSettings]:bUseBorderlessWindow=True
#     -ini:Input:[/Script/Engine.InputSettings]:DefaultPlayerInputClass=/Script/DisplayCluster.DisplayClusterPlayerInput
#     -unattended -NoScreenMessages -fixedseed -NoVerifyGC -noxrstereo
#     -RemoteControlIsHeadless -StageFriendlyName="Node_0" Log=Node_0.log
#
# Prerequisites:
#   - Populate ndisplay_map and ndisplay_config in
#     inventories/hrlv-dev/group_vars/ue_content.yml
#   - Plastic SCM synced (playbooks/plastic-sync.yml)
#   - Firewall rules applied (playbooks/ue-firewall-rules.yml)
#
# Usage:
#   ansible-playbook playbooks/ue-ndisplay-start.yml
#   ansible-playbook playbooks/ue-ndisplay-start.yml -e "ndisplay_map=/Game/Path/To/Map"
#   ansible-playbook playbooks/ue-ndisplay-start.yml -e "skip_preflight=true"  # fast relaunch

- name: Check for already-running UE instances
  hosts: ue_content
  gather_facts: false

  tasks:
    - name: Check if UnrealEditor is running
      ansible.windows.win_shell: |
        $procs = Get-Process -Name UnrealEditor -ErrorAction SilentlyContinue
        if ($procs) { Write-Host "RUNNING $($procs.Count)" } else { Write-Host "NONE" }
      register: ue_running_check
      changed_when: false

    - name: Fail if UE is already running
      ansible.builtin.fail:
        msg: "UnrealEditor is already running on {{ inventory_hostname }}. Run ue-ndisplay-stop.yml first."
      when: "'RUNNING' in ue_running_check.stdout"

- name: GPU health check
  ansible.builtin.import_playbook: gpu-health-check.yml

- name: Prime OVS FDB for Rivermax hardware offload
  ansible.builtin.import_playbook: rivermax-arp-prime.yml

- name: Preflight and prepare nDisplay launch
  hosts: ue_content
  gather_facts: false

  tasks:
    - name: Validate nDisplay config is set
      ansible.builtin.assert:
        that:
          - ndisplay_config | length > 0
          - ndisplay_node is defined
        fail_msg: "ndisplay_config and ndisplay_node must be set. Populate ue_content.yml and hosts.yml."

    - name: Rivermax preflight check
      ansible.windows.win_shell: |
        $errors = @()
        if (!(Test-Path 'C:\Program Files\Mellanox\Rivermax\lib\rivermax.dll')) { $errors += 'Rivermax DLL missing' }
        if (!(Test-Path 'C:\Program Files\Mellanox\Rivermax\lib\rivermax.lic')) { $errors += 'License file missing' }
        $env = [System.Environment]::GetEnvironmentVariable('RIVERMAX_LICENSE_PATH', 'Machine')
        if (!$env) { $errors += 'RIVERMAX_LICENSE_PATH env var not set' }
        $adapter = Get-NetAdapter | Where-Object { $_.InterfaceDescription -like '*Mellanox*' -or $_.InterfaceDescription -like '*ConnectX*' }
        if (!$adapter) { $errors += 'No Mellanox/ConnectX adapter found' }
        if ($errors.Count -gt 0) { Write-Host "FAIL: $($errors -join '; ')" } else { Write-Host "OK" }
      register: rivermax_preflight
      changed_when: false
      when:
        - not (skip_preflight | default(false) | bool)
        - ndisplay | default('') is match('rivermax.*')

    - name: Fail if Rivermax is not ready
      ansible.builtin.fail:
        msg: "Rivermax preflight FAILED on {{ inventory_hostname }}: {{ rivermax_preflight.stdout | trim }}. Fix: ansible-playbook playbooks/rivermax-setup.yml --limit {{ inventory_hostname }}"
      when:
        - rivermax_preflight is not skipped
        - "'FAIL' in rivermax_preflight.stdout"

    - name: Validate files and read nDisplay node config
      ansible.windows.win_shell: |
        $result = @{ config = 'OK'; map = 'OK'; window = $null }
        if (!(Test-Path "{{ ndisplay_config }}")) {
          $result.config = 'MISSING'
        } else {
          $cfg = Get-Content "{{ ndisplay_config }}" -Raw | ConvertFrom-Json
          $node = $cfg.nDisplay.cluster.nodes."{{ ndisplay_node }}"
          $result.window = @{
            winx = [int]$node.window.x
            winy = [int]$node.window.y
            resx = [int]$node.window.w
            resy = [int]$node.window.h
            fullscreen = [bool]$node.fullScreen
            headless = [bool]$node.renderHeadless
          }
        }
        {% if ndisplay_map is defined and ndisplay_map != 'None' %}
        $mapPath = "{{ unreal_project | dirname }}/Content/{{ ndisplay_map | regex_replace('^/Game/', '') }}.umap"
        if (!(Test-Path $mapPath)) { $result.map = 'MISSING' }
        {% endif %}
        $result | ConvertTo-Json -Compress
      register: validate_result
      changed_when: false

    - name: Parse validation results
      ansible.builtin.set_fact:
        preflight: "{{ validate_result.stdout | from_json }}"

    - name: Fail if nDisplay config not found
      ansible.builtin.fail:
        msg: "nDisplay config not found: {{ ndisplay_config }}"
      when: preflight.config == 'MISSING'

    - name: Fail if map not found
      ansible.builtin.fail:
        msg: "Map not found: {{ ndisplay_map }} (looked for {{ unreal_project | dirname }}/Content/{{ ndisplay_map | regex_replace('^/Game/', '') }}.umap)"
      when: preflight.map == 'MISSING'

    - name: Set node window config
      ansible.builtin.set_fact:
        ndisplay_window: "{{ preflight.window }}"

    - name: Build nDisplay launch arguments
      ansible.builtin.set_fact:
        ndisplay_args: >-
          "{{ unreal_project }}"
          -game
          {{ ndisplay_map | default('None') }}
          -dc_cluster
          -dc_cfg="{{ ndisplay_config }}"
          -dc_node={{ ndisplay_node }}
          -dc_dev_mono
          -ini:Engine:[/Script/Engine.Engine]:GameEngine=/Script/DisplayCluster.DisplayClusterGameEngine,[/Script/Engine.Engine]:GameViewportClientClassName=/Script/DisplayCluster.DisplayClusterViewportClient,[/Script/Engine.UserInterfaceSettings]:bAllowHighDPIInGameMode=True,[/Script/Engine.UserInterfaceSettings]:bAllowHighDpiWhenUnattended=True,[ConsoleVariables]:Rivermax.Output.EnableMultiSRD=1{% if concert_server_ip is defined %},[/Script/UdpMessaging.UdpMessagingSettings]:MulticastEndpoint=0.0.0.0:0,[/Script/UdpMessaging.UdpMessagingSettings]:MulticastTimeToLive=0,[/Script/QuicMessaging.QuicMessagingSettings]:EnableTransport=False{% endif %}
          -ini:Game:[/Script/EngineSettings.GeneralProjectSettings]:bUseBorderlessWindow=True
          -ini:Input:[/Script/Engine.InputSettings]:DefaultPlayerInputClass=/Script/DisplayCluster.DisplayClusterPlayerInput
          -unattended
          -NoScreenMessages
          -nosplash
          -fixedseed
          -NoVerifyGC
          -noxrstereo
          {% if ndisplay_window.fullscreen | bool %}-fullscreen{% else %}-windowed -forceres WinX={{ ndisplay_window.winx }} WinY={{ ndisplay_window.winy }} ResX={{ ndisplay_window.resx }} ResY={{ ndisplay_window.resy }}{% endif %}
          {% if ndisplay_window.headless | bool %}-RenderOffscreen{% endif %}
          {% if concert_server_ip is defined %}-messaging -CONCERTAUTOCONNECT -CONCERTSERVER="{{ concert_server_name }}" -CONCERTSESSION="{{ concert_session }}" -CONCERTDISPLAYNAME="{{ inventory_hostname }}" -UDPMESSAGING_TRANSPORT_UNICAST={{ ansible_host }}:0 -UDPMESSAGING_TRANSPORT_STATIC={{ concert_server_ip }}:{{ concert_server_port }}{% endif %}
          -RemoteControlIsHeadless
          -StageFriendlyName="{{ ndisplay_node }}"
          Log={{ ndisplay_node }}.log

    - name: Write nDisplay launch script
      ansible.windows.win_copy:
        content: |
          @echo off
          "{{ unreal_exe }}" {{ ndisplay_args }}
        dest: C:\ndisplay-launch.bat

    - name: Create nDisplay scheduled task
      community.windows.win_scheduled_task:
        name: nDisplayLaunch
        description: Launch UE in nDisplay mode
        actions:
          - path: C:\ndisplay-launch.bat
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

- name: Launch nDisplay cluster
  hosts: ue_content
  gather_facts: false

  tasks:
    - name: Start nDisplay on all nodes
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "nDisplayLaunch"
        Write-Host "LAUNCHED"

    - name: Wait for UE process to appear
      ansible.windows.win_shell: |
        $timeout = 30
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          $proc = Get-Process -Name UnrealEditor -ErrorAction SilentlyContinue
          if ($proc) {
            Write-Host "RUNNING (PID: $($proc.Id))"
            exit 0
          }
          Start-Sleep -Seconds 2
          $elapsed += 2
        }
        throw "UnrealEditor did not start within ${timeout}s"
      register: launch_result

    - name: Show launch status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} ({{ ndisplay_node }}): {{ launch_result.stdout | trim }}"
