---
# Test Rivermax stream reception using NVIDIA media_receiver
# Runs on a receiver node in the interactive session to verify 2110 streams.
#
# Usage:
#   ansible-playbook playbooks/rmax-receive-test.yml --limit windows-unreal-render-05
#   ansible-playbook playbooks/rmax-receive-test.yml --limit windows-unreal-render-05 -e "rmax_test_multicast=225.0.0.2"

- name: Rivermax receive test
  hosts: windows
  gather_facts: false

  vars:
    rmax_receiver: 'C:\Program Files\Mellanox\Rivermax\apps\media_receiver\media_receiver.exe'
    rmax_test_multicast: "225.0.0.1"
    rmax_test_port: 50000
    rmax_test_pixel_format: "RGB_10"
    rmax_test_duration: 10

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\temp"
        state: directory

    - name: Write receive test script
      ansible.windows.win_copy:
        content: |
          @echo off
          "{{ rmax_receiver }}" -i {{ media_ip }} -m {{ rmax_test_multicast }} -p {{ rmax_test_port }} --pixel-format {{ rmax_test_pixel_format }} > C:\temp\rmax-receive-test.log 2>&1
        dest: C:\temp\rmax-receive-test.bat

    - name: Remove old test results
      ansible.windows.win_file:
        path: "C:\\temp\\rmax-receive-test.log"
        state: absent

    - name: Create receive test scheduled task
      community.windows.win_scheduled_task:
        name: RmaxReceiveTest
        description: Rivermax media_receiver test
        actions:
          - path: C:\temp\rmax-receive-test.bat
        triggers: []
        username: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        logon_type: interactive_token
        run_level: highest
        state: present
        enabled: true

    - name: Run receive test
      ansible.windows.win_shell: |
        Start-ScheduledTask -TaskName "RmaxReceiveTest"
        Write-Host "STARTED"

    - name: Wait for test to produce output
      ansible.windows.win_shell: |
        Start-Sleep -Seconds {{ rmax_test_duration }}
        Stop-ScheduledTask -TaskName "RmaxReceiveTest" -ErrorAction SilentlyContinue
        if (Test-Path C:\temp\rmax-receive-test.log) {
          Get-Content C:\temp\rmax-receive-test.log
        } else {
          Write-Host "NO OUTPUT"
        }
      register: test_output

    - name: Show test results
      ansible.builtin.debug:
        msg: "{{ test_output.stdout }}"

    - name: Clean up scheduled task
      community.windows.win_scheduled_task:
        name: RmaxReceiveTest
        state: absent
